# VCU通信协议详解：CVT与电机控制

## 1. 概述

本文档详细定义了混合动力自主拖拉机VCU（车辆控制单元）与CVT（无级变速器）和电机控制器之间进行通信所使用的CAN总线协议。清晰、可靠的通信协议是实现VCU对动力总成系统进行精确、高效控制的基础。

**通信架构概览:**

* **物理层**: CAN-FD, 500 kbps
* **VCU-CVT通信**: 基于J1939协议
* **VCU-电机通信**: 采用私有CAN协议

## 2. VCU-CVT通信协议 (J1939)

VCU与CVT之间的通信遵循SAE J1939标准，使用扩展帧格式。VCU作为控制方，向CVT发送控制指令；CVT作为执行方，向VCU回报状态信息。

### 2.1 VCU → CVT 控制消息

此消息用于VCU向CVT下达控制指令，如设定目标传动比、切换控制模式等。

* **PGN**: 61445 (0xF005) - Transmission Control 1 (TC1)
* **优先级**: 3
* **发送速率**: 20ms

| SPN | 名称                            | 字节  | 位   | 长度  | 分辨率        | 偏移量 | 数据范围     | 单位  |
| --- | ----------------------------- | --- | --- | --- | ---------- | --- | -------- | --- |
| 523 | Transmission Requested Ratio  | 1-2 | 1   | 16  | 0.001 /bit | 0   | 0-65.535 | -   |
| 524 | Transmission Control Mode     | 3   | 1   | 4   | 1 /bit     | 0   | 0-15     | -   |
| 525 | Transmission Enable Flag      | 3   | 5   | 2   | 1 /bit     | 0   | 0-3      | -   |
| 526 | Transmission Max Torque Limit | 4-5 | 1   | 16  | 1 /bit     | 0   | 0-65535  | Nm  |
| -   | 保留                            | 6-8 | -   | -   | -          | -   | -        | -   |

**数据字节定义:**

* **字节 1-2 (LSB, MSB)**: **目标传动比**。例如，要设定传动比为1.8, 则发送值为 `1.8 / 0.001 = 1800` (0x0708)。
* **字节 3**: 
  * **位 1-4**: **控制模式**。 (0: 自动模式, 1: 手动模式, 2: 经济模式, 3: 动力模式)
  * **位 5-6**: **使能标志**。 (0: 禁用, 1: 启用)
* **字节 4-5 (LSB, MSB)**: **最大扭矩限制**。CVT允许承受的最大输入扭矩。

### 2.2 CVT → VCU 状态消息

此消息用于CVT向VCU回报其当前的工作状态，包括实际传动比、输入/输出转速、油温、故障信息等。

* **PGN**: 61446 (0xF006) - Transmission Status 1 (TS1)
* **优先级**: 3
* **发送速率**: 50ms

| SPN | 名称                         | 字节  | 位   | 长度  | 分辨率        | 偏移量 | 数据范围       | 单位  |
| --- | -------------------------- | --- | --- | --- | ---------- | --- | ---------- | --- |
| 527 | Transmission Current Ratio | 1-2 | 1   | 16  | 0.001 /bit | 0   | 0-65.535   | -   |
| 190 | Engine Speed (Input Speed) | 3-4 | 1   | 16  | 0.125 /bit | 0   | 0-8031.875 | RPM |
| 161 | Transmission Output Speed  | 5-6 | 1   | 16  | 0.125 /bit | 0   | 0-8031.875 | RPM |
| 175 | Engine Oil Temperature 1   | 7   | 1   | 8   | 1 /bit     | -40 | -40 to 210 | °C  |
| 127 | Transmission Oil Pressure  | 8   | 1   | 8   | 4 /bit     | 0   | 0-1000     | kPa |

* **PGN**: 65262 (0xFEFE) - Transmission Fault Codes (DM1)
* **优先级**: 6
* **发送速率**: 1s (或按需)

| SPN  | 名称                                | 字节  | 位   | 长度  | 描述       |
| ---- | --------------------------------- | --- | --- | --- | -------- |
| 1213 | Malfunction Indicator Lamp Status | 1   | 1   | 2   | 故障指示灯状态  |
| 987  | Protected Lamp Status             | 1   | 5   | 2   | 保护灯状态    |
| 623  | Red Stop Lamp Status              | 1   | 7   | 2   | 红色停止灯状态  |
| 624  | Amber Warning Lamp Status         | 2   | 1   | 2   | 黄色警告灯状态  |
| 1214 | SPN of Fault                      | 3-5 | 1   | 19  | 发生故障的SPN |
| 1215 | FMI of Fault                      | 5   | 4   | 5   | 故障模式指示符  |
| 1216 | Occurrence Count                  | 6   | 1   | 7   | 故障发生次数   |

## 3. VCU-电机通信协议 (私有CAN)

VCU与电机控制器之间的通信采用私有CAN协议，使用29位扩展ID。该协议为实时性要求更高的电机控制进行了优化。

### 3.1 VCU → 电机 控制消息

此消息用于VCU向电机控制器发送高频率的扭矩或转速控制指令。

* **CAN ID**: 0x1806E5F4 (示例)
* **发送速率**: 10ms

| 字节  | 名称          | 分辨率 | 偏移量     | 数据范围              | 单位   | 描述               |
| --- | ----------- | --- | ------- | ----------------- | ---- | ---------------- |
| 0-1 | **目标扭矩**    | 0.1 | -3276.8 | -3276.8 to 3276.7 | Nm   | 正值为驱动扭矩，负值为回收扭矩  |
| 2-3 | **目标转速**    | 1   | 0       | 0-65535           | RPM  | 仅在速度控制模式下有效      |
| 4   | **控制模式**    | 1   | 0       | 0-255             | -    | 0: 扭矩模式, 1: 速度模式 |
| 5   | **使能标志**    | 1   | 0       | 0-255             | -    | 0: 禁用, 1: 启用     |
| 6-7 | **扭矩变化率限制** | 1   | 0       | 0-65535           | Nm/s | 限制扭矩的上升和下降速率     |

**编码示例 (目标扭矩):**

要发送 `-150.5 Nm` 的回收扭矩指令:
`Value = (-150.5 - (-3276.8)) / 0.1 = 31263` (0x7A1F)

### 3.2 电机 → VCU 状态消息 1 (高频)

此消息用于电机控制器向VCU高频回报核心状态信息。

* **CAN ID**: 0x1806E6F4 (示例)
* **发送速率**: 10ms

| 字节  | 名称         | 分辨率 | 偏移量     | 数据范围              | 单位  | 描述                         |
| --- | ---------- | --- | ------- | ----------------- | --- | -------------------------- |
| 0-1 | **实际扭矩**   | 0.1 | -3276.8 | -3276.8 to 3276.7 | Nm  | 电机当前输出的实际扭矩                |
| 2-3 | **实际转速**   | 1   | 0       | 0-65535           | RPM | 电机当前实际转速                   |
| 4-5 | **直流母线电压** | 0.1 | 0       | 0-6553.5          | V   | 逆变器直流侧电压                   |
| 6   | **电机状态**   | 1   | 0       | 0-255             | -   | 0: 待机, 1: 运行, 2: 故障, 3: 跛行 |
| 7   | **当前故障代码** | 1   | 0       | 0-255             | -   | 当前活动的最高优先级故障代码             |

### 3.3 电机 → VCU 状态消息 2 (低频)

此消息用于电机控制器向VCU低频回报温度等非实时性要求高的状态信息。

* **CAN ID**: 0x1806E7F4 (示例)
* **发送速率**: 100ms

| 字节  | 名称         | 分辨率 | 偏移量 | 数据范围         | 单位  | 描述           |
| --- | ---------- | --- | --- | ------------ | --- | ------------ |
| 0   | **电机定子温度** | 1   | -40 | -40 to 215   | °C  | 定子绕组温度       |
| 1   | **电机转子温度** | 1   | -40 | -40 to 215   | °C  | 转子永磁体温度      |
| 2   | **逆变器温度**  | 1   | -40 | -40 to 215   | °C  | 功率模块（IGBT）温度 |
| 3   | **冷却液温度**  | 1   | -40 | -40 to 215   | °C  | 冷却系统液体温度     |
| 4-7 | **累计运行时间** | 1   | 0   | 0-4294967295 | s   | 电机系统累计运行时间   |
