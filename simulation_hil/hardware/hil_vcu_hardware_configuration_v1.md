# HIL测试中的VCU硬件配置详解 v1.0

## 1. HIL测试硬件配置概述

本篇文档详细阐述了在混合动力自主拖拉机VCU的HIL（硬件在环）测试中，所需的真实VCU硬件以及与之配套的dSPACE SCALEXIO仿真平台硬件配置。特别地，本文档将重点介绍为了实现高保真CVT和电机仿真而需要新增的硬件模块。

**HIL测试的核心理念**：将真实的被测控制器（在这里是VCU硬件）置于一个由实时仿真器模拟的虚拟工作环境中。仿真器模拟了VCU在真实拖拉机上会遇到的所有外部信号和系统响应，从而可以在实验室环境下安全、高效、可重复地测试VCU的功能和性能。

## 2. VCU硬件选型与配置

在HIL测试中，被测对象是**真实的VCU硬件**，而非其仿真模型。这确保了测试结果能够真实反映VCU硬件在实际工作中的表现，包括其时序特性、电气特性和热特性。

### 2.1 推荐方案：英飞凌TC397TP开发板

考虑到开发周期、成本和功能完整性，我们推荐使用英飞凌官方的**AURIX TC397 Application Kit**作为HIL测试中的VCU硬件。

| 方案      | VCU硬件       | 成本      | 优缺点                         | 推荐度   |
| ------- | ----------- | ------- | --------------------------- | ----- |
| **方案A** | TC397TP开发板  | ~$2,000 | 功能完整，立即可用，成本低，官方支持。         | ⭐⭐⭐⭐⭐ |
| **方案B** | 定制TC397 PCB | ~$8,000 | 更接近最终产品形态，但开发周期长，成本高。       | ⭐⭐⭐   |
| **方案C** | 第三方VCU      | ~$5,000 | 现成方案，但与最终目标硬件不符，测试结果参考价值有限。 | ⭐⭐    |

**TC397TP开发板核心规格:**

* **MCU**: TC397TP (6核TriCore @ 300MHz)
* **内存**: 8MB Flash, 1MB RAM
* **通信**: 8路CAN-FD, 2路千兆以太网
* **I/O**: 丰富的GPIO, ADC, PWM等接口
* **调试**: DAP miniWiggler接口

使用官方开发板可以在项目早期快速搭建HIL测试环境，验证VCU软件的核心算法和控制逻辑。

## 3. dSPACE SCALEXIO仿真平台硬件配置

dSPACE SCALEXIO作为HIL测试的核心，其硬件配置需要根据测试需求进行精确选择。为了支持高保真的CVT和电机仿真，我们需要在基础配置之上增加专用的I/O模块。

### 3.1 基础配置

基础配置满足了常规的车辆总线通信和传感器/执行器信号仿真需求。

| 模块         | 型号         | 数量  | 主要功能           | 价格 (估算)     |
| ---------- | ---------- | --- | -------------- | ----------- |
| 处理器单元      | DS2655     | 1   | 实时模型运算核心       | $25,000     |
| CAN接口模块    | DS2654     | 2   | 4路CAN-FD/板，共8路 | $18,000     |
| 模拟I/O模块    | DS2655-AIO | 1   | 32路AI, 16路AO   | $12,000     |
| 数字I/O模块    | DS2655-DIO | 1   | 64路DI, 32路DO   | $8,000      |
| 电源模块       | DS2655-PSU | 1   | 可编程电源          | $7,000      |
| **基础配置总计** |            |     |                | **$70,000** |

### 3.2 CVT与电机仿真扩展模块

为了实现对CVT和电机的精确仿真，必须增加以下专用模块：

| 模块          | 型号             | 数量    | 主要功能                        | 价格 (估算)     |
| ----------- | -------------- | ----- | --------------------------- | ----------- |
| **PWM输出模块** | **DS2655-PWM** | **1** | **6路互补PWM输出，用于仿真逆变器门极驱动信号** | **$10,000** |
| **编码器接口模块** | **DS2655-ENC** | **1** | **4路编码器输入/输出，用于仿真电机转子位置信号** | **$9,000**  |
| **液压仿真模块**  | **DS2655-HYD** | **1** | **专用液压系统仿真，用于高保真CVT液压控制**   | **$15,000** |
| **扩展模块总计**  |                |       |                             | **$34,000** |

### 3.3 完整HIL平台硬件配置清单

综合基础配置和扩展模块，一套能够完整支持混合动力拖拉机VCU测试的dSPACE SCALEXIO平台硬件配置如下：

| 模块          | 型号             | 数量    | 价格 (估算)      |
| ----------- | -------------- | ----- | ------------ |
| 处理器单元       | DS2655         | 1     | $25,000      |
| CAN接口模块     | DS2654         | 2     | $18,000      |
| 模拟I/O模块     | DS2655-AIO     | 1     | $12,000      |
| 数字I/O模块     | DS2655-DIO     | 1     | $8,000       |
| 电源模块        | DS2655-PSU     | 1     | $7,000       |
| **PWM输出模块** | **DS2655-PWM** | **1** | **$10,000**  |
| **编码器接口模块** | **DS2655-ENC** | **1** | **$9,000**   |
| **液压仿真模块**  | **DS2655-HYD** | **1** | **$15,000**  |
| 机箱及附件       |                | 1     | $15,000      |
| **总计**      |                |       | **$119,000** |

## 4. 增强型HIL硬件连接方案

正确的硬件连接是HIL测试成功的基础。这包括VCU与dSPACE平台之间的CAN总线连接、模拟/数字I/O连接，以及为CVT和电机仿真新增的PWM和编码器信号连接。

### 4.1 物理连接架构

物理连接的核心是通过一个信号调理板（Breakout Box）将dSPACE的I/O模块与TC397TP开发板的接口相连。这个调理板同时也方便了信号测量和故障注入。

![HIL系统完整集成架构](../testing/hil_system_integration.png)

### 4.2 详细连接表 (增强版)

下表详细列出了dSPACE SCALEXIO与TC397TP VCU之间的信号连接，重点突出了CVT和电机仿真所需的新增连接。

#### CAN总线连接

| HIL仿真器端 (DS2654) | TC397开发板端 | 用途            |
| ---------------- | --------- | ------------- |
| CAN0 (J1939)     | CAN0      | 发动机通信         |
| **CAN1 (专用协议)**  | **CAN1**  | **电机控制器通信**   |
| **CAN2 (J1939)** | **CAN2**  | **CVT通信**     |
| CAN3 (专用协议)      | CAN3      | 电池管理系统(BMS)通信 |
| CAN4 (ISOBUS)    | CAN4      | 农具通信          |
| CAN5 (J1939)     | CAN5      | 底盘及其他ECU通信    |

#### 模拟与数字I/O连接

| HIL仿真器端 (DS2655) | TC397开发板端 | 信号类型     | 用途                 |
| ---------------- | --------- | -------- | ------------------ |
| AO0              | ADC0      | 0-5V     | 模拟油门踏板信号           |
| AO1              | ADC1      | 0-5V     | 模拟制动踏板信号           |
| **AO2**          | **ADC2**  | **0-5V** | **模拟CVT液压压力传感器**   |
| **AO3**          | **ADC3**  | **0-5V** | **模拟电机温度传感器**      |
| DI0              | GPIO16    | 24V      | VCU状态输出 (例如，运行/故障) |
| DO0              | GPIO0     | 24V      | 模拟点火开关信号 (KL15)    |

#### **电机仿真专用I/O连接**

| HIL仿真器端 (DS2655)   | TC397开发板端 | 信号类型      | 用途                            |
| ------------------ | --------- | --------- | ----------------------------- |
| **PWM0-5 (来自VCU)** | **AI0-5** | **PWM**   | **接收VCU的6路PWM门极驱动信号，用于逆变器仿真** |
| **ENC0 (输出到VCU)**  | **ENC0**  | **A/B/Z** | **向VCU提供仿真的电机转子位置和速度信号**      |
| **AO4**            | **ADC4**  | **0-5V**  | **模拟电机相电流U**                  |
| **AO5**            | **ADC5**  | **0-5V**  | **模拟电机相电流V**                  |
| **AO6**            | **ADC6**  | **0-5V**  | **模拟直流母线电压**                  |

**重要说明**: 在实际连接中，VCU的PWM输出被HIL的模拟输入通道捕获，以分析VCU生成的门极驱动信号的占空比和频率。然后，HIL内部的电机模型根据这些信号以及其他参数计算出电机的行为，并通过编码器仿真模块（ENC）将结果反馈给VCU的编码器输入接口。同时，HIL通过模拟输出（AO）向VCU的模拟输入（ADC）提供仿真的相电流和母线电压信号。
