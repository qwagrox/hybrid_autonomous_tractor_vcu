# HIL测试计划与验证方案 v1.0

## 1. 测试目标与范围

本测试计划旨在全面验证混合动力自主拖拉机VCU（车辆控制单元）在集成了高保真CVT和电机仿真模块的HIL（硬件在环）测试平台上的功能、性能、鲁棒性和安全性。

**核心测试目标:**

1. **验证混合动力控制策略**: 确保VCU能够根据工况（如负载、车速、驾驶员意图）最优地协调发动机、电机和CVT的工作，实现最佳的动力性、经济性和驾驶性。
2. **验证CVT控制功能**: 测试VCU对CVT传动比的精确控制、模式切换的平顺性以及对CVT故障的诊断和处理能力。
3. **验证电机控制功能**: 测试VCU对电机扭矩/转速的精确控制、能量回收策略的有效性以及对电机系统故障的诊断和处理能力。
4. **验证系统鲁棒性与安全性**: 通过大量的故障注入和边缘工况测试，确保VCU在异常情况下的行为符合设计预期，保证系统和人员安全。

**测试范围:**

* **被测对象**: 运行在TC397TP硬件上的VCU软件。
* **测试环境**: dSPACE SCALEXIO HIL平台，包含发动机、CVT、电机、电池、农具及环境的实时仿真模型。
* **测试级别**: 系统集成测试。

## 2. 测试环境与资源

### 2.1 硬件资源

| 硬件      | 型号/规格                      | 数量  | 备注                                 |
| ------- | -------------------------- | --- | ---------------------------------- |
| HIL仿真平台 | dSPACE SCALEXIO            | 1   | 包含处理器、CAN、模拟/数字I/O、PWM、编码器、液压仿真模块  |
| 被测VCU   | 英飞凌 TC397TP 开发板            | 1   | 运行待测试的VCU软件                        |
| 测试PC    | Dell Precision Workstation | 1   | 运行dSPACE ControlDesk, 测试脚本, 数据分析软件 |
| 信号调理板   | 自定义                        | 1   | 用于HIL与VCU之间的信号连接、调理和故障注入           |
| 可编程电源   | Keysight E36313A           | 1   | 为VCU提供12V/24V供电                    |
| CAN分析仪  | Vector CANcaseXL           | 1   | 用于监控和分析CAN总线数据                     |

### 2.2 软件资源

| 软件                               | 版本     | 用途                                        |
| -------------------------------- | ------ | ----------------------------------------- |
| dSPACE ControlDesk               | 2023-A | HIL测试环境主控软件，用于实验管理、参数标定、数据采集              |
| dSPACE Real-Time Interface (RTI) | 2023-A | 将Simulink模型编译为实时应用程序                      |
| MATLAB/Simulink                  | R2023a | 用于开发和维护仿真模型 (发动机、CVT、电机等)                 |
| Python                           | 3.9    | 用于编写自动化测试脚本 (使用dSPACE AutomationDesk API) |
| Git                              | 2.34.1 | 用于VCU软件和测试脚本的版本控制                         |
| AURIX Development Studio         | 1.9.20 | 用于VCU软件的编译、下载和调试                          |

### 2.3 人力资源

| 角色       | 职责                      |
| -------- | ----------------------- |
| 测试工程师    | 负责测试用例设计、测试执行、结果分析和报告撰写 |
| HIL系统工程师 | 负责HIL平台的搭建、维护和模型开发      |
| VCU软件工程师 | 负责VCU软件的开发、Bug修复和版本发布   |

## 3. 测试用例设计

以下是针对VCU混合动力控制策略、CVT控制、电机控制以及故障诊断等关键功能的详细测试用例。

### 3.1 CVT控制测试用例

**目标**: 验证VCU对CVT传动比的控制精度、动态响应和模式切换的正确性。

| 测试用例ID   | HIL-CVT-001                                                                                                                                                               |
| -------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| **测试项**  | **传动比阶跃响应测试**                                                                                                                                                             |
| **测试目标** | 验证VCU能否快速、准确地控制CVT达到目标传动比，并评估其动态性能（超调、响应时间）。                                                                                                                              |
| **前置条件** | 1. HIL系统运行正常，CVT模型加载完成。<br>2. VCU上电，与HIL建立CAN通信。<br>3. 发动机模型运行在1800 RPM，负载扭矩为500 Nm。                                                                                      |
| **测试步骤** | 1. VCU发送指令将CVT置于手动模式，初始传动比为2.0。<br>2. 等待系统稳定后，记录当前实际传动比。<br>3. VCU发送指令将目标传动比阶跃设置为1.0。<br>4. 监控并记录实际传动比、响应时间、超调量和稳态误差。<br>5. VCU发送指令将目标传动比阶跃设置为2.5。<br>6. 再次监控并记录相关动态性能指标。 |
| **预期结果** | 1. 稳态误差：实际传动比与目标传动比之差 < 2%。<br>2. 响应时间（90%达到目标值）：< 1.5秒。<br>3. 超调量：< 10%。<br>4. 系统无持续振荡。                                                                                  |

| 测试用例ID   | HIL-CVT-002                                                                                                                                                                                                                  |
| -------- | ---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| **测试项**  | **控制模式切换测试**                                                                                                                                                                                                                 |
| **测试目标** | 验证VCU能否平顺地在自动、手动、经济、动力等不同控制模式间切换。                                                                                                                                                                                            |
| **前置条件** | 1. HIL系统运行正常，车辆模型以8 km/h行驶。<br>2. VCU上电，与HIL建立CAN通信。                                                                                                                                                                         |
| **测试步骤** | 1. VCU将CVT置于自动模式，模拟正常行驶工况。<br>2. VCU发送指令切换到动力模式，同时模拟负载增加（如坡度增加）。<br>3. 监控传动比变化趋势是否符合动力模式逻辑（倾向于更大的传动比以获得扭矩）。<br>4. VCU发送指令切换到经济模式，同时模拟负载减小。<br>5. 监控传动比变化趋势是否符合经济模式逻辑（倾向于更小的传动比以降低发动机转速）。<br>6. VCU发送指令切换到手动模式，并手动设定几个不同的传动比。 |
| **预期结果** | 1. 模式切换过程中，系统输出扭矩无明显中断或突变。<br>2. 各模式下传动比的变化逻辑符合设计预期。<br>3. 手动模式下，CVT能够精确跟随设定的传动比。                                                                                                                                            |

### 3.2 电机控制测试用例

**目标**: 验证VCU对电机扭矩/转速的控制精度、能量回收策略的有效性以及动态响应能力。

| 测试用例ID   | HIL-MOTOR-001                                                                                                                                          |
| -------- | ------------------------------------------------------------------------------------------------------------------------------------------------------ |
| **测试项**  | **扭矩控制精度与响应测试**                                                                                                                                        |
| **测试目标** | 验证VCU能否精确控制电机输出目标扭矩，并测试其响应速度。                                                                                                                          |
| **前置条件** | 1. HIL系统运行正常，电机模型加载完成。<br>2. VCU上电，与HIL建立CAN通信。<br>3. 电机处于待命状态，转速为1500 RPM（由发动机拖动）。                                                                    |
| **测试步骤** | 1. VCU发送指令将电机置于扭矩控制模式。<br>2. VCU发送指令要求电机输出100 Nm的驱动扭矩。<br>3. 监控并记录实际输出扭矩、响应时间（达到90%目标扭矩的时间）和稳态误差。<br>4. VCU发送指令要求电机输出-80 Nm的回收扭矩。<br>5. 再次监控并记录相关性能指标。 |
| **预期结果** | 1. 稳态误差：实际扭矩与目标扭矩之差 < 5 Nm。<br>2. 响应时间：< 50毫秒。<br>3. 电流和扭矩波形平滑，无异常振荡。                                                                                  |

| 测试用例ID   | HIL-MOTOR-002                                                                                                                                                            |
| -------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------ |
| **测试项**  | **制动能量回收测试**                                                                                                                                                             |
| **测试目标** | 验证在制动工况下，VCU能否有效利用电机进行能量回收，并合理分配电制动和机械制动。                                                                                                                                |
| **前置条件** | 1. HIL系统运行正常，车辆模型以15 km/h的速度行驶。<br>2. 电池SOC为60%。                                                                                                                         |
| **测试步骤** | 1. 模拟驾驶员进行中等强度的制动（如，制动踏板开度50%）。<br>2. 监控VCU发送给电机控制器的回收扭矩指令。<br>3. 监控电机实际输出的回收扭矩和回收到电池的电流。<br>4. 监控机械制动系统的介入情况。<br>5. 模拟驾驶员进行紧急制动（如，制动踏板开度100%）。<br>6. 再次监控电制动和机械制动的分配情况。 |
| **预期结果** | 1. 在中等强度制动下，VCU应优先使用电机进行能量回收，机械制动介入较少。<br>2. 在紧急制动下，电机制动和机械制动应协同工作，以提供最大的制动力。<br>3. 整个制动过程中，车辆减速度平稳，符合预期。<br>4. 电池SOC在制动后应有明确的上升。                                        |

### 3.3 混合动力控制策略测试用例

**目标**: 验证VCU在混合动力模式下，对发动机、电机、CVT的协同控制能力，以实现最优的动力和经济性。

| 测试用例ID   | HIL-HYBRID-001                                                                                                                  |
| -------- | ------------------------------------------------------------------------------------------------------------------------------- |
| **测试项**  | **扭矩辅助（Torque Assist）功能测试**                                                                                                     |
| **测试目标** | 验证在负载突增时，VCU能否快速调用电机提供辅助扭矩，以维持发动机在高效区工作并保证车辆动力。                                                                                 |
| **前置条件** | 1. HIL系统运行正常，车辆模型以8 km/h的速度在平地行驶。<br>2. 发动机运行在1600 RPM，电池SOC为70%。<br>3. VCU处于混合动力自动模式。                                          |
| **测试步骤** | 1. 模拟农具负载突然增加（例如，犁地遇到坚硬土质），使发动机负载超过80%。<br>2. 监控VCU对电机下达的扭矩指令。<br>3. 监控发动机转速和负载的变化。<br>4. 监控CVT传动比的变化。<br>5. 负载恢复正常后，监控电机的退出过程。 |
| **预期结果** | 1. 在负载增加后100ms内，电机应开始输出辅助扭矩。<br>2. 发动机转速波动应在±100 RPM以内，避免失速或超速。<br>3. VCU可能会适当增加CVT传动比，与电机协同提供扭矩。<br>4. 负载恢复后，电机应平滑地减少扭矩至零。     |

| 测试用例ID   | HIL-HYBRID-002                                                                                                      |
| -------- | ------------------------------------------------------------------------------------------------------------------- |
| **测试项**  | **行车充电（In-Drive Charging）功能测试**                                                                                     |
| **测试目标** | 验证在电池SOC较低且车辆负载不高时，VCU能否利用发动机的富余功率为电池充电。                                                                            |
| **前置条件** | 1. HIL系统运行正常，车辆模型以10 km/h的速度在平地行驶。<br>2. 电池SOC降低至30%。<br>3. 发动机负载为40%。                                              |
| **测试步骤** | 1. 维持车辆工况稳定。<br>2. 监控VCU是否启动行车充电模式。<br>3. 监控VCU对电机下达的负扭矩（发电）指令。<br>4. 监控发动机负载的变化，应有所增加。<br>5. 监控电池SOC的变化。           |
| **预期结果** | 1. 当SOC低于预设阈值（如35%）且发动机有富余功率时，VCU应启动行车充电。<br>2. 电机应工作在发电模式，产生负扭矩。<br>3. 发动机负载应增加，增加的负载约等于电机的发电功率。<br>4. 电池SOC应缓慢回升。 |

### 3.4 故障注入与诊断测试用例

**目标**: 验证VCU在面对关键零部件故障或通信异常时，能否准确诊断故障、执行正确的降级策略，并确保系统安全。

| 测试用例ID   | HIL-FAULT-001                                                                                                                                                                                                          |
| -------- | ---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| **测试项**  | **CVT液压压力传感器故障测试**                                                                                                                                                                                                     |
| **测试目标** | 验证VCU能否检测到CVT液压压力传感器信号异常（如信号丢失、超出范围），并采取相应的跛行回家（Limp-Home）策略。                                                                                                                                                          |
| **前置条件** | 1. HIL系统运行正常，车辆正常行驶。<br>2. VCU处于混合动力自动模式。                                                                                                                                                                              |
| **测试步骤** | 1. 通过HIL的故障注入单元，将CVT液压压力传感器信号设置为0V（模拟断路）。<br>2. 监控VCU是否在规定时间内（如500ms）检测到该故障。<br>3. 监控VCU是否通过CAN总线报出正确的故障代码（DM1消息）。<br>4. 监控VCU是否执行了预设的降级策略，例如：<br>   - 将CVT锁定在某个固定的安全传动比。<br>   - 限制发动机和电机的输出扭矩。<br>   - 点亮仪表盘上的故障指示灯。 |
| **预期结果** | 1. VCU能在500ms内检测到故障。<br>2. VCU能发送包含正确SPN和FMI的DM1消息。<br>3. VCU能执行预设的跛行回家策略，限制车辆性能但保证基本行驶能力。<br>4. 故障清除后，系统能恢复正常运行。                                                                                                      |

| 测试用例ID   | HIL-FAULT-002                                                                                                                                                                 |
| -------- | ----------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| **测试项**  | **电机编码器信号丢失测试**                                                                                                                                                               |
| **测试目标** | 验证VCU在电机编码器信号丢失时，能否快速切换到无传感器控制模式（如果支持）或安全地停用电机。                                                                                                                               |
| **前置条件** | 1. HIL系统运行正常，电机提供辅助扭矩。                                                                                                                                                        |
| **测试步骤** | 1. 通过HIL的故障注入单元，中断A/B/Z相编码器信号的传输。<br>2. 监控VCU的响应时间。<br>3. 监控VCU是否报出电机编码器故障代码。<br>4. 监控VCU的控制策略变化：<br>   - 理想情况：切换到无传感器控制模式，电机仍能提供有限的扭矩。<br>   - 安全底线：平滑地将电机扭矩降至零，并完全由发动机提供动力。 |
| **预期结果** | 1. VCU能在100ms内检测到编码器信号丢失。<br>2. VCU能报出正确的故障代码。<br>3. VCU能无冲击地切换控制策略，保证车辆动力平顺。<br>4. 系统进入安全的降级运行模式。                                                                            |

| 测试用例ID   | HIL-FAULT-003                                                                                                                                                                 |
| -------- | ----------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| **测试项**  | **VCU-电机CAN通信中断测试**                                                                                                                                                           |
| **测试目标** | 验证在VCU与电机控制器之间的CAN通信中断时，电机控制器自身的安全机制以及VCU的监控机制是否能被正确触发。                                                                                                                       |
| **前置条件** | 1. HIL系统运行正常，车辆正常行驶。                                                                                                                                                          |
| **测试步骤** | 1. 通过HIL的CAN模块，断开VCU与电机控制器之间的CAN总线连接。<br>2. 监控电机控制器的行为（应在接收超时后，自动将扭矩降至零）。<br>3. 监控VCU的行为（应在发送/接收超时后，检测到通信丢失故障）。<br>4. 监控VCU是否报出通信超时故障代码。<br>5. 监控VCU是否执行相应的降级策略（如，完全依赖发动机行驶）。 |
| **预期结果** | 1. 通信中断后，电机控制器应在100ms内将输出扭矩降至零。<br>2. VCU应在500ms内检测到通信超时故障并报警。<br>3. VCU应切换到纯发动机驱动模式，并限制车辆性能。<br>4. 通信恢复后，系统应能通过驾驶员的重启操作等方式恢复正常。                                              |
