# 农具集成指南

- **版本**: 1.0
- **作者**: [tangyong@stmail.ujs.edu.cn](mailto:tangyong@stmail.ujs.edu.cn)
- **日期**: 2025/09/19

## 1. 概述

本指南详细说明了如何为 `hybrid_autonomous_tractor_vcu` 项目集成新的农具类型。遵循本指南，开发者可以快速地将新的农具控制器无缝集成到现有系统中，而无需修改核心控制逻辑。

## 2. 集成步骤

集成一个新的农具主要包括以下四个步骤：

1. **创建配置文件**: 为新农具定义一个YAML配置文件。
2. **实现控制器接口**: 创建一个新的C++类，该类继承自 `IImplementController` 并实现其定义的纯虚函数。
3. **注册控制器**: 在主系统 `main_vcu_system.cpp` 中注册新的控制器实例。
4. **更新构建系统**: 将新的源文件和头文件添加到 `CMakeLists.txt` 中。

### 步骤 1: 创建配置文件

在 `config/implements/` 目录下，为您的新农具创建一个新的 `.yaml` 文件。例如，`new_implement_config.yaml`。文件内容应遵循以下结构：

```yaml
implement:
  type: "NewImplement"  # 必须与控制器中 getType() 返回值一致
  name: "Manufacturer Model XYZ" # 农具的具体型号
  work_width: 5.0 # 工作宽度 (米)

  # ISOBUS 通信参数 (根据农具文档填写)
  isobus:
    destination_address: 0x29
    pgn_rate_control: 0xEF06
    pgn_enable_control: 0xEF07

  # 特定于该农具的作业参数
  parameters:
    custom_param_1: 123.45
    custom_param_2: 67.89
```

### 步骤 2: 实现控制器接口

1. **创建头文件**: 在 `include/control/implement_drivers/` 目录下创建一个新的头文件，例如 `new_implement_controller.hpp`。该文件需要包含 `i_implement_controller.hpp` 并声明您的新控制器类。
   
   ```cpp
   #ifndef NEW_IMPLEMENT_CONTROLLER_HPP
   #define NEW_IMPLEMENT_CONTROLLER_HPP
   
   #include "../i_implement_controller.hpp"
   
   class NewImplementController : public IImplementController {
   public:
       explicit NewImplementController(std::shared_ptr<ISOBUSAdapter> adapter);
       std::string getType() const override { return "NewImplement"; }
       // ... 实现所有 IImplementController 的虚函数 ...
   };
   
   #endif
   ```

2. **创建源文件**: 在 `src/control/implement_drivers/` 目录下创建对应的 `.cpp` 文件。在此文件中，您需要实现所有在头文件中声明的函数。核心逻辑是根据 `setWorkParameter` 的输入，通过 `ISOBUSAdapter` 发送正确的PGN和数据。
   
   ```cpp
   #include "path/to/new_implement_controller.hpp"
   
   // ... 构造函数和其他函数的实现 ...
   
   bool NewImplementController::setWorkParameter(const std::string& key, double value) {
       if (key == "custom_param_1") {
           // 假设 PGN 0xEF06 用于设置这个参数
           isobus_adapter_->sendValueCommand(config_.isobus.destination_address, config_.isobus.pgn_rate_control, value);
           return true;
       }
       return false;
   }
   ```

### 步骤 3: 注册控制器

打开 `src/main_vcu_system.cpp` 文件，在 `initializeAlgorithms` 函数中，找到注册现有驱动的位置，并添加一行来注册您的新驱动。

```cpp
// ... 在 initializeAlgorithms() 中 ...

// 注册农具驱动
implementControlManager_->registerDriver(std::make_shared<PlowController>(isobusAdapter_));
// ... 其他驱动 ...

implementControlManager_->registerDriver(std::make_shared<NewImplementController>(isobusAdapter_)); // 添加此行
```

同时，不要忘记在文件顶部包含新创建的头文件：

```cpp
#include "control/implement_drivers/new_implement_controller.hpp"
```

### 步骤 4: 更新构建系统

最后，打开项目根目录下的 `CMakeLists.txt` 文件，将您的新 `.cpp` 文件添加到可执行文件的源文件列表中。

```cmake
# ... 在 add_executable 指令中 ...

add_executable(vcu_main
    src/main_vcu_system.cpp
    # ... 其他源文件 ...
    src/control/implement_drivers/plow_controller.cpp
    src/control/implement_drivers/seeder_controller.cpp
    src/control/implement_drivers/fertilizer_controller.cpp
    src/control/implement_drivers/sprayer_controller.cpp
    src/control/implement_drivers/new_implement_controller.cpp # 添加此行
)
```

完成以上步骤后，重新编译项目，新的农具控制器即可被系统识别和使用。
