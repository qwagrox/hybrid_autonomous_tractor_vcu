# 农具控制系统架构设计

- **版本**: 1.0
- **作者**: [tangyong@agrox.cloud](mailto:tangyong@agrox.cloud)
- **日期**: 2025/09/18

## 1. 概述

本文档旨在为 `hybrid_autonomous_tractor_vcu` 项目设计一个模块化、可扩展且符合工业级标准的农具控制系统架构。该架构将支持多种农具（犁、播种机、施肥机、喷药机）的即插即用，并确保系统的安全性、可靠性和实时性。

## 2. 架构图

以下是农具控制系统的核心架构图，展示了各组件之间的关系和交互流程。

![image](https://github.com/qwagrox/hybrid_autonomous_tractor_vcu/blob/main/img/implement_control_architecture_diagram.png)

## 3. 组件说明

| 组件                            | 描述                                                                                |
| ----------------------------- | --------------------------------------------------------------------------------- |
| **Implement Control Manager** | 系统的核心协调器。负责根据上层任务规划，加载和管理相应的农具驱动，并协调各组件工作。                                        |
| **Implement Interface**       | 定义了一套标准的抽象接口，所有农具驱动都必须实现此接口。这确保了系统的可扩展性，新增农具只需实现此接口即可。                            |
| **Implement Drivers**         | 针对具体农具（犁、播种机等）的控制逻辑实现。每个驱动负责解析农具配置、处理特定指令，并通过ISOBUS适配器与硬件通信。                      |
| **Implement State Machine**   | 管理每个农具的生命周期状态（如：`IDLE`, `CONFIGURED`, `ACTIVE`, `TRANSPORT`, `FAULT`)，确保操作的有序和安全。 |
| **Implement Health Monitor**  | 负责监控农具的健康状况，如传感器数据、执行器反馈和通信状态。检测到异常时，将触发故障处理流程。                                   |
| **Config Loader**             | 在系统启动时，负责从YAML文件中读取农具的配置参数（如物理尺寸、控制定点、校准数据），并将其提供给相应的驱动。                          |
| **ISOBUS Adapter**            | 封装了ISOBUS (ISO 11783)协议的复杂性，为上层驱动提供简化的API来发送指令和接收数据。它将与现有的`CAN Bus Manager`集成。    |
| **Physical Implements**       | 代表通过ISOBUS连接到拖拉机上的物理农具硬件。                                                         |

## 4. 数据流与控制流

1. **初始化**: 系统启动时，`Config Loader`加载所有可用的农具配置文件。`Implement Control Manager`根据当前挂接的农具（可通过ISOBUS即插即用功能识别）或默认配置，加载相应的`Implement Driver`。
2. **任务执行**: `Task Planner`向`Implement Control Manager`发送高级指令（如“在A点开始播种，速率为X”）。
3. **指令处理**: `Manager`将指令分发给当前激活的`Driver`。`Driver`根据指令和配置参数，生成具体的ISOBUS消息。
4. **通信**: `Driver`通过`ISOBUS Adapter`将消息发送到CAN总线。
5. **状态反馈**: 农具硬件执行指令后，通过ISOBUS返回状态信息。`ISOBUS Adapter`接收并解析这些信息，`Driver`更新内部状态，并通过`Implement Health Monitor`和`Implement State Machine`向上层报告。
6. **闭环控制**: 对于需要精确控制的任务（如耕深保持），`Driver`将形成一个实时闭环，持续调整控制指令以匹配设定点。
7. **故障处理**: `Health Monitor`持续监控数据流。一旦检测到故障（如通信超时、执行器错误），它将通知`State Machine`切换到`FAULT`状态，并由`Manager`执行预定义的故障恢复策略。

## 5. 接口定义 (初步)

为了实现模块化，`Implement Interface`将定义以下核心方法：

```cpp
class IImplementController {
public:
    virtual ~IImplementController() = default;

    // 初始化农具
    virtual bool initialize(const ImplementConfig& config) = 0;

    // 启动作业
    virtual bool start() = 0;

    // 停止作业
    virtual bool stop() = 0;

    // 设置作业参数（如速率、深度）
    virtual bool setWorkParameter(const std::string& key, double value) = 0;

    // 获取当前状态
    virtual ImplementStatus getStatus() = 0;

    // 执行诊断
    virtual DiagnosticReport runDiagnostics() = 0;
};
```

此架构为实现一个健壮、灵活的农具控制系统奠定了基础。
